!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).biliMirror={})}(this,(function(e){"use strict";var t=function(){return t=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},t.apply(this,arguments)};function n(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function c(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){a.label=c[1];break}if(6===c[0]&&a.label<o[1]){a.label=o[1],o=c;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(c);break}o[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}"function"==typeof SuppressedError&&SuppressedError;var o,i=!1;function a(){return!1===i&&(i="undefined"!=typeof window),i}var c=function(){if(a())return window}();function s(){if(a())return c.__biliMirror__=c.__biliMirror__||{},c.__biliMirror__}var u=a()&&(null===(o=document.getElementsByTagName("meta").spm_prefix)||void 0===o?void 0:o.content)||"0.0";function l(e,t,n,r){void 0===r&&(r=!1),e.addEventListener(t,n,r)}function f(){return Date.now()}var p=Object.prototype.toString;function d(e){return function(t){return p.call(t)==="[object ".concat(e,"]")}}var h={isNumber:d("Number"),isString:d("String"),isBoolean:d("Boolean"),isNull:d("Null"),isUndefined:d("Undefined"),isSymbol:d("Symbol"),isFunction:d("Function"),isObject:d("Object"),isArray:d("Array"),isProcess:d("process"),isWindow:d("Window")};function m(e){var t=/^[0-9a-zA-Z_-]+$/.test(e);return t||console.warn("字符串:".concat(e,",不符合条件,任意数字,字母、下划线、中划线组成")),t}function v(e,t){void 0===t&&(t=["chrome-extension"]);var n=(null==e?void 0:e.message)||"",r=(null==e?void 0:e.fileName)||"";if(!n)return!0;if((n=n.split("?")[0]).includes(location.hostname))return!0;if(!t.length)return!1;var o=!1;if(r)for(var i=0;i<t.length;i++)if(r.match(t[i])){o=!0;break}if(o)return o;for(i=0;i<t.length;i++)if(n.match(t[i])){o=!0;break}return o}function g(e){if("0"===e)return 0;if(h.isNumber(e))return e>10?10:e<=0?1:e;if(h.isString(e)&&!isNaN(e)){var t=parseInt(e);return t>10?10:t<=0?1:t}return console.warn("mirror-kv-[config] sampling rate error,pleace set 1-10"),1}function y(e){return Math.floor(10*Math.random()+1)>e}function b(){return"undefined"==typeof document||null==document.location?"":document.location.href}function R(e){if(!e)return{};var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};var n=t[6]||"",r=t[8]||"";return{host:t[4],path:t[5],protocol:t[2],relative:t[5]+n+r}}function E(e,t,n,r){if(void 0===r&&(r=!1),void 0!==e&&(t in e||r)){var o=n(e[t]);"function"==typeof o&&(e[t]=o)}}function w(e){return e&&"object"==typeof e&&!Array.isArray(e)}function O(e,t){var n=Object.assign({},e);return w(e)&&w(t)&&Object.keys(t).forEach((function(r){var o,i;w(t[r])?r in e?n[r]=O(e[r],t[r]):Object.assign(n,((o={})[r]=t[r],o)):Object.assign(n,((i={})[r]=t[r],i))})),n}var S="1.5.18",T="@bilibili/bili-mirror",I=S;function P(){return P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},P.apply(this,arguments)}function N(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var _,k,C,L=2592e6;!function(e){e[e.NON_STRICT=0]="NON_STRICT",e[e.STRICT=1]="STRICT"}(_||(_={})),function(e){e.KEY="key",e.GROUP="group",e.APP="app"}(k||(k={})),function(e){e.PV="333.1334.kv-init.pv",e.ERROR="333.1334.kv-init.error"}(C||(C={}));var A=new(function(){function e(){this.queue=[],this.reporter=void 0,this.loading=!1}var t=e.prototype;return t.loadScript=function(e,t){try{var n=document;return Promise.resolve(new Promise((function(r,o){var i,a=document.getElementById(e);a&&a.parentElement&&window.ReporterPb?r(""):((a=n.createElement("script")).onload=function(){return r("")},a.onreadystatechange=function(){this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||r("")},a.onerror=function(){return o("load report script error")},a.id=e,a.type="text/JavaScript",a.src=t,null==(i=n.querySelector("head"))||i.appendChild(a))})))}catch(e){return Promise.reject(e)}},t.init=function(){try{var e=this;return Promise.resolve(function(t,n){try{var r=function(){function t(){e.reporter=new window.ReporterPb({spmPrefix:"333.1334",sampleRate:1,autoPv:!1,retry:!1,feature:{tech:!0}}),e.loading=!1,e.reportQueue()}if(!e.reporter&&void 0!==typeof window&&!e.loading){e.loading=!0;var n=function(){if(!window.ReporterPb)return Promise.resolve(e.loadScript("kvReportDb","//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js")).then((function(){}))}();return n&&n.then?n.then(t):t()}}()}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,(function(t){e.loading=!1,console.error(t)})))}catch(e){return Promise.reject(e)}},t.reportQueue=function(){if(this.reporter)for(var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return N(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?N(e,t):void 0}}(e))){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.queue);!(e=t()).done;){var n=e.value;this.report(n.event,n.value)}},t.report=function(e,t){void 0===t&&(t={});try{if(!this.reporter)return this.queue.push({event:e,value:t}),void this.init();var n=P({type:e===C.ERROR?"error":"custom"},t);this.reporter.tech(e,n)}catch(e){console.error(e)}},e}()),j="KV_CONFIG_SDK",x=function(){function e(e){var t=e.appKey,n=e.nscode;this.appKey=void 0,this.appKeyStorageName=void 0,this.appKey=t,this.appKeyStorageName=t+"_"+n,this.checkLocalStorage()}var t=e.prototype;return t.checkLocalStorage=function(){var t=e.getLocalStorage();if(t){for(var n in t){var r=(new Date).getTime();t[n].timestamp+t[n].expires<r&&delete t[n]}Object.keys(t).length>40&&Object.keys(t).sort((function(e,n){return t[e].lastUsed-t[n].lastUsed})).slice(40).forEach((function(e){delete t[e]})),e.setLocalStorage(t)}},t.getAppKey=function(){var t=e.getLocalStorage()||{};return t[this.appKeyStorageName]?(t[this.appKeyStorageName].lastUsed=(new Date).getTime(),e.setLocalStorage(t),t[this.appKeyStorageName]||{}):{}},t.setAppkey=function(t){var n=P({timestamp:(new Date).getTime(),lastUsed:(new Date).getTime()},t),r=e.getLocalStorage()||{};r[this.appKeyStorageName]=n,e.setLocalStorage(r)},e.getLocalStorage=function(){var e;try{(e=localStorage.getItem(j))&&(e=JSON.parse(e))}catch(t){console.error("从本地获取"+j+"的时候异常",t),e=void 0,A.report(C.ERROR,{message:"从本地获取"+j+"的时候异常"+(t.message||"")})}return e},e.setLocalStorage=function(e){try{localStorage.setItem(j,JSON.stringify(e))}catch(e){!function(e){var t=!1;if(e)if(e.code)switch(e.code){case 22:t=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===e.name&&(t=!0)}else-2147024882===e.number&&(t=!0);return t}(e)?(console.log("storage 更新失败",e),A.report(C.ERROR,{message:"storage 更新失败"+(e.message||"")})):(console.log("storage 超出浏览器限制",e),A.report(C.ERROR,{message:"storage 超出浏览器限制"+(e.message||"")}))}},e}();function M(e,t,n){return new Promise((function(r,o){(function(e,t){return new Promise((function(n,r){var o=new XMLHttpRequest;function i(){if(o){var e,t,i=o.responseType,a=(e=o.getAllResponseHeaders().trim().split(/[\r\n]+/),t={},e.forEach((function(e){var n=e.split(": "),r=n.shift(),o=n.join(": ");r&&(t[r]=o)})),t);!o.status||o.status>=200&&o.status<=299?n({data:i&&"text"!==i?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:a}):r(new Error("Request Error: "+o.status+" "+o.statusText)),o=null}}if(o.open((null==t?void 0:t.method)||"GET",e,!0),o.timeout=(null==t?void 0:t.timeout)||2e3,o.responseType=(null==t?void 0:t.responseType)||"json",o.onreadystatechange=function(){o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))&&setTimeout(i)},o.onabort=function(){o&&(r(new Error("Request aborted: "+e)),o=null)},o.onerror=function(){r(new Error("Network Error: "+e)),o=null},o.ontimeout=function(){r(null!=t&&t.timeout?"Timeout exceeded: "+t.timeout:"Timeout exceeded"),o=null},o.withCredentials=(null==t?void 0:t.withCredentials)||!1,null!=t&&t.headers)for(var a in t.headers)o.setRequestHeader(a,t.headers[a]);o.send((null==t?void 0:t.data)||null)}))})(function(e,t,n){void 0===t&&(t={});var r=t?Object.keys(t).map((function(e){return e+"="+t[e]})).join("&"):"";return""+((null==n?void 0:n.baseURL)||window.location.protocol+"//"+"api.YmlsaWJpbGk=.com".split(".").map((function(e,t){return 1===t?window.atob(e):e})).join("."))+e+(r?"?"+r:"")}(e,t,n),{method:"GET"}).then((function(e){var t=e.data,n=void 0===t?{}:t;0===n.code?r(n):o(n)}),(function(e){o(e)})).catch((function(e){o(e)}))}))}function D(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var H=function(){function e(e){this.options={appKey:"",apiURL:"",nscode:0,expires:L,strict:_.STRICT},this.storage=void 0,this.fetchPromise=void 0,this.flattenValue={},this.nestedValue={};var t=e.appKey,n=e.expires,r=void 0===n?L:n;if(!t)return A.report(C.ERROR,{message:"no appkey passed"}),void console.warn("appKey is required");this.options=P({},this.options,e,{expires:Math.min(r,L)}),this.storage=new x({appKey:t,nscode:this.options.nscode});var o=this.storage.getAppKey(),i=o.versionId;this.updateValue(o.value||{}),(this.options.strict!==_.NON_STRICT||e.autoFetch)&&(this.fetchPromise=this.fetchAppKey(i)),this.report(C.PV)}var t=e.prototype;return t.getAll=function(){try{return Promise.resolve(this.getBase(k.APP))}catch(e){return Promise.reject(e)}},t.getGroup=function(e){try{return Promise.resolve(this.getBase(k.GROUP,e))}catch(e){return Promise.reject(e)}},t.get=function(e){try{return Promise.resolve(this.getBase(k.KEY,e))}catch(e){return Promise.reject(e)}},t.getBase=function(e,t){void 0===t&&(t="");try{var n=this,r=function(){if(e===k.APP)return n.nestedValue;if(e===k.GROUP)return n.nestedValue[t]||{};var r=t.split("."),o=r[0];return n.nestedValue[o]?n.nestedValue[o][r[1]]:""};if(n.options.strict===_.NON_STRICT||!n.options.appKey)return Promise.resolve(r());if(!n.fetchPromise){var o=n.storage.getAppKey();n.fetchPromise=n.fetchAppKey(o.versionId)}return Promise.resolve(n.fetchPromise.then((function(){return r()})))}catch(e){return Promise.reject(e)}},t.fetchAppKey=function(e){try{var t=this,n=t.options,r=n.appKey,o=n.nscode,i=D((function(){return Promise.resolve(M("/x/kv-frontend/namespace/data",{appKey:r,versionId:e,nscode:o},{baseURL:t.options.apiURL})).then((function(e){var n=e.data;t.storage.setAppkey({value:n.data,versionId:n.versionId,appVersionId:n.appVersionId,nscode:o,appKey:t.options.appKey,expires:t.options.expires}),t.updateValue(n.data)}))}),(function(e){-304!==e.code&&t.report(C.ERROR,{message:e.message||e.msg||"获取失败"})}));return Promise.resolve(i&&i.then?i.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},e.updateLocalAppKey=function(e){try{return Promise.resolve(D((function(){var t=e.appKey,n=e.appVersionId,r=e.apiBaseURL,o=x.getLocalStorage();if(o){var i=Object.keys(o).filter((function(e){return o[e].appKey===t&&o[e].appVersionId!==n})).map((function(e){return o[e]}));if(i.length)return Promise.resolve(M("/x/kv-frontend/app/batchupdates",{appKey:t,batches:JSON.stringify(i.map((function(e){return{appVersionId:e.appVersionId,nscode:e.nscode}})))},{baseURL:r})).then((function(e){var n=e.data,r=x.getLocalStorage()||{};n.forEach((function(e){var n=t+"_"+e.nscode;if(e.deleted)delete r[n];else if(e.updated){var o={timestamp:(new Date).getTime(),value:e.data,versionId:e.versionId,appVersionId:e.appVersionId,nscode:e.nscode,appKey:t};r[n]=P({},r[n]||{},o)}})),x.setLocalStorage(r)}))}}),(function(e){-304!==e.code&&console.error(e)})))}catch(e){return Promise.reject(e)}},t.updateValue=function(e){var t=this;this.flattenValue=e;var n={};Object.keys(this.flattenValue).forEach((function(e){var r=e.split("."),o=r[0],i=r[1];n[o]||(n[o]={}),n[o][i]=t.flattenValue[e]})),this.nestedValue=n},t.report=function(e,t){void 0===t&&(t={}),A.report(e,P({appKey:this.options.appKey,nscode:this.options.nscode,sdkVersion:"1.2.7"},t))},e}(),K=s(),U="333.1333",B="bilimirror",F="whitelist",V=function(){function e(){this.origin="bili",this.module="common",this.config={},this._defaultConfigSDK=new H({appKey:U,strict:_.STRICT})}return e.prototype.fetchWhiteListConfig=function(e,t){var n=this;return new Promise((function(r,o){e.get(t).then((function(e){if(e){var t=JSON.parse(e);n.config.white=(null==t?void 0:t.white)||[],n.config["white-retry"]=(null==t?void 0:t.retry)||[],n.config["white-preformance-rate"]=t.performance?g(null==t?void 0:t.performance):1,n.config["poll-time"]=t.poll?g(null==t?void 0:t.poll):5,n.config["tech-pv"]=t.techpv?g(null==t?void 0:t.techpv):5,n.config["user-log"]=(null==t?void 0:t.userLog)||[],n.config["resource-time"]=(null==t?void 0:t.resourceTime)||{},r(t)}else o()})).catch((function(e){o(e)}))}))},e.prototype.getConfig=function(){var e=this;return new Promise((function(t){var n,r,o=U,i=B,a=F,c=e.spmId||u;c!==o?(e._configSDK&&c===(null===(r=null===(n=e._configSDK)||void 0===n?void 0:n.options)||void 0===r?void 0:r.appKey)||(delete e._configSDK,e._configSDK=new H({appKey:c,strict:_.STRICT})),e.fetchWhiteListConfig(e._configSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(n){console.warn("bili-mirror:not find ".concat(c," kv-config,using base")),e.fetchWhiteListConfig(e._defaultConfigSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(e){t(),console.warn("bilimirror获取白名单配置失败")}))}))):e.fetchWhiteListConfig(e._defaultConfigSDK,"".concat(i,".").concat(a)).then((function(){t()})).catch((function(e){t(),console.warn("bilimirror获取白名单配置失败")}))}))},e.prototype.bindOptions=function(e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){switch(n.label){case 0:return K.mirrorVersion=I,Object.keys(e).forEach((function(n){"config"!==n&&("module"===n&&"function"==typeof e[n]?t[n]=e[n]():t[n]=e[n])})),[4,this.getConfig()];case 1:return n.sent(),[2,Promise.resolve("ok")]}}))}))},e.prototype.updateModule=function(e){this.module=e},e}();function J(){return K.options||(K.options=new V)}var W=a()?J():null;function q(e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return a()?[4,W.bindOptions(e)]:[3,2];case 1:return[2,t.sent()];case 2:return[2]}}))}))}var G,$,Y,X,Q,z,Z,ee,te,ne,re=-1,oe=function(e){addEventListener("pageshow",(function(t){t.persisted&&(re=t.timeStamp,e(t))}),!0)},ie=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},ae=function(){var e=ie();return e&&e.activationStart||0},ce=function(e,t){var n=ie(),r="navigate";return re>=0?r="back-forward-cache":n&&(document.prerendering||ae()>0?r="prerender":document.wasDiscarded?r="restore":n.type&&(r=n.type.replace(/_/g,"-"))),{name:e,value:void 0===t?-1:t,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},se=function(e,t,n){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var r=new PerformanceObserver((function(e){Promise.resolve().then((function(){t(e.getEntries())}))}));return r.observe(Object.assign({type:e,buffered:!0},n||{})),r}}catch(e){}},ue=function(e,t,n,r){var o,i;return function(a){t.value>=0&&(a||r)&&((i=t.value-(o||0))||void 0===o)&&(o=t.value,t.delta=i,t.rating=function(e,t){return e>t[1]?"poor":e>t[0]?"needs-improvement":"good"}(t.value,n),e(t))}},le=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},fe=function(e){var t=function(t){"pagehide"!==t.type&&"hidden"!==document.visibilityState||e(t)};addEventListener("visibilitychange",t,!0),addEventListener("pagehide",t,!0)},pe=function(e){var t=!1;return function(n){t||(e(n),t=!0)}},de=-1,he=function(){return"hidden"!==document.visibilityState||document.prerendering?1/0:0},me=function(e){"hidden"===document.visibilityState&&de>-1&&(de="visibilitychange"===e.type?e.timeStamp:0,ge())},ve=function(){addEventListener("visibilitychange",me,!0),addEventListener("prerenderingchange",me,!0)},ge=function(){removeEventListener("visibilitychange",me,!0),removeEventListener("prerenderingchange",me,!0)},ye=function(){return de<0&&(de=he(),ve(),oe((function(){setTimeout((function(){de=he(),ve()}),0)}))),{get firstHiddenTime(){return de}}},be=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},Re=[1800,3e3],Ee=function(e,t){t=t||{},be((function(){var n,r=ye(),o=ce("FCP"),i=se("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(i.disconnect(),e.startTime<r.firstHiddenTime&&(o.value=Math.max(e.startTime-ae(),0),o.entries.push(e),n(!0)))}))}));i&&(n=ue(e,o,Re,t.reportAllChanges),oe((function(r){o=ce("FCP"),n=ue(e,o,Re,t.reportAllChanges),le((function(){o.value=performance.now()-r.timeStamp,n(!0)}))})))}))},we=[.1,.25],Oe={passive:!0,capture:!0},Se=new Date,Te=function(e,t){G||(G=t,$=e,Y=new Date,Ne(removeEventListener),Ie())},Ie=function(){if($>=0&&$<Y-Se){var e={entryType:"first-input",name:G.type,target:G.target,cancelable:G.cancelable,startTime:G.timeStamp,processingStart:G.timeStamp+$};X.forEach((function(t){t(e)})),X=[]}},Pe=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){Te(e,t),o()},r=function(){o()},o=function(){removeEventListener("pointerup",n,Oe),removeEventListener("pointercancel",r,Oe)};addEventListener("pointerup",n,Oe),addEventListener("pointercancel",r,Oe)}(t,e):Te(t,e)}},Ne=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,Pe,Oe)}))},_e=[100,300],ke=[2500,4e3],Ce={},Le=[800,1800],Ae=function e(t){document.prerendering?be((function(){return e(t)})):"complete"!==document.readyState?addEventListener("load",(function(){return e(t)}),!0):setTimeout(t,0)},je=function(e,t){t=t||{};var n=ce("TTFB"),r=ue(e,n,Le,t.reportAllChanges);Ae((function(){var o=ie();if(o){var i=o.responseStart;if(i<=0||i>performance.now())return;n.value=Math.max(i-ae(),0),n.entries=[o],r(!0),oe((function(){n=ce("TTFB",0),(r=ue(e,n,Le,t.reportAllChanges))(!0)}))}}))},xe=function(e){return!!a()&&function(){try{return a()&&PerformanceObserver?PerformanceObserver.supportedEntryTypes||[]:null}catch(e){console.error("bili-mirror: supportList 解析异常:",e)}}().includes(e)};function Me(e){window.performance.getEntriesByType&&window.addEventListener("load",(function(){var t=window.performance;t&&setTimeout((function(){var n=t.getEntriesByType("navigation")[0],r={redirectTime:n.redirectEnd-n.redirectStart,dnsTime:n.domainLookupEnd-n.domainLookupStart,tcpTime:n.connectEnd-n.connectStart,sslTime:"https:"===location.protocol?n.connectEnd-n.secureConnectionStart:0,ttfbTime:n.responseStart-n.startTime,requestDoneTime:n.responseEnd-n.responseStart,domParseTime:n.domContentLoadedEventEnd-n.responseEnd,resourceDownloadTime:n.loadEventEnd-n.domContentLoadedEventEnd,pageTime:n.duration};e({name:"PAGETIME",data:r,value:1})}),0)}))}function De(e){/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)?(!function(e){if(xe("first-input")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];t.disconnect();var a=i.processingStart-i.startTime;e({name:"FID",value:a,rating:a<100?"good":a>100&&a<300?"normal":"poor"})}}));t.observe({type:"first-input",buffered:!0})}}((function(t){e(t)})),function(e){if(xe("paint")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];"first-contentful-paint"===i.name&&(t.disconnect(),e({name:"FCP",value:i.startTime,rating:i.startTime<1600?"good":i.startTime>1600&&i.startTime<3e3?"normal":"poor"}))}}));t.observe({type:"paint",buffered:!0})}}((function(t){e(t)})),function(e){if(xe("largest-contentful-paint")){var t=new PerformanceObserver((function(n){for(var r=0,o=n.getEntries();r<o.length;r++){var i=o[r];t.disconnect(),e({name:"LCP",value:i.startTime,rating:i.startTime<1600?"good":i.startTime>1600&&i.startTime<3e3?"normal":"poor"})}}));t.observe({type:"largest-contentful-paint",buffered:!0})}}((function(t){e(t)})),function(e){window.addEventListener("load",(function(){var t=window.performance.timing,n=t.responseStart-t.navigationStart;e({name:"TTFB",value:n,rating:n<200?"good":n>200&&n<500?"normal":"poor"})}))}((function(t){e(t)})),Me((function(t){e(t)}))):(!function(e,t){t=t||{},be((function(){var n,r=ye(),o=ce("LCP"),i=function(e){var t=e[e.length-1];t&&t.startTime<r.firstHiddenTime&&(o.value=Math.max(t.startTime-ae(),0),o.entries=[t],n())},a=se("largest-contentful-paint",i);if(a){n=ue(e,o,ke,t.reportAllChanges);var c=pe((function(){Ce[o.id]||(i(a.takeRecords()),a.disconnect(),Ce[o.id]=!0,n(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,c,!0)})),fe(c),oe((function(r){o=ce("LCP"),n=ue(e,o,ke,t.reportAllChanges),le((function(){o.value=performance.now()-r.timeStamp,Ce[o.id]=!0,n(!0)}))}))}}))}((function(t){e(t)})),function(e,t){t=t||{},be((function(){var n,r=ye(),o=ce("FID"),i=function(e){e.startTime<r.firstHiddenTime&&(o.value=e.processingStart-e.startTime,o.entries.push(e),n(!0))},a=function(e){e.forEach(i)},c=se("first-input",a);n=ue(e,o,_e,t.reportAllChanges),c&&fe(pe((function(){a(c.takeRecords()),c.disconnect()}))),c&&oe((function(){var r;o=ce("FID"),n=ue(e,o,_e,t.reportAllChanges),X=[],$=-1,G=null,Ne(addEventListener),r=i,X.push(r),Ie()}))}))}((function(t){e(t)})),function(e,t){t=t||{},Ee(pe((function(){var n,r=ce("CLS",0),o=0,i=[],a=function(e){e.forEach((function(e){if(!e.hadRecentInput){var t=i[0],n=i[i.length-1];o&&e.startTime-n.startTime<1e3&&e.startTime-t.startTime<5e3?(o+=e.value,i.push(e)):(o=e.value,i=[e])}})),o>r.value&&(r.value=o,r.entries=i,n())},c=se("layout-shift",a);c&&(n=ue(e,r,we,t.reportAllChanges),fe((function(){a(c.takeRecords()),n(!0)})),oe((function(){o=0,r=ce("CLS",0),n=ue(e,r,we,t.reportAllChanges),le((function(){return n()}))})),setTimeout(n,0))})))}((function(t){e(t)})),Ee((function(t){e(t)})),je((function(t){e(t)})),Me((function(t){e(t)})))}!function(e){e.INIT="init",e.ERROR="error",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.PERFORMANCE="performance",e.WHITESCREEN="whiteScreen",e.BREABCRUMB="breadcrumb"}(Q||(Q={})),function(e){e.ERROR="error",e.CLICK="click",e.HISTORY="history",e.HASHCHANGE="hashchange",e.UNHANDLEDREJECTION="unhandledrejection",e.RESOURCE="resource",e.WHITE="white",e.CUSTOM="custom"}(z||(z={})),function(e){e.BEFORE="mirrorHandlerBefore",e.AFTER="mirrorHandlerAfter"}(Z||(Z={})),function(e){e.ERROR="error",e.OK="ok"}(ee||(ee={})),function(e){e.AUTO="auto",e.DEFAULT="default"}(te||(te={})),function(e){e.HISTORY="history",e.HASH="hash",e.DOM="dom",e.JS="js",e.PROMISE="promise",e.RESOURCE="resource",e.WHITE="white"}(ne||(ne={}));var He={isExclusive:1},Ke={mirrorPolymer:3},Ue=function(e,t,o){void 0===t&&(t="before");var i=[],a=!1,c=0;return{start:function(){var s=this;return new Promise((function(u){return n(s,void 0,void 0,(function(){var n,s,l,f,p;return r(this,(function(r){switch(r.label){case 0:if(a)return[2];a=!0,r.label=1;case 1:return c<e.length?(n=e[c],"before"!==t?[3,3]:(l=(s=i).push,[4,null==n?void 0:n.mirrorHandleBefore(o.type,o.data)])):[3,6];case 2:return l.apply(s,[r.sent()]),[3,5];case 3:return p=(f=i).push,[4,null==n?void 0:n.mirrorHandleAfter(o.type,o.data)];case 4:p.apply(f,[r.sent()]),r.label=5;case 5:return c++,a?[3,1]:[2];case 6:return a=!1,u(i),[2]}}))}))}))}}},Be=function(){function e(){this.timeID=null,this.func=null}return e.prototype.repeat=function(e,t){var n=this;null===this.func&&(this.func=e),this.func===e&&(this.timeID=setTimeout((function(){e(),n.repeat(e,t)}),t))},e.prototype.clear=function(){clearTimeout(this.timeID)},e}(),Fe=null,Ve=null,Je=6e4*((null==W?void 0:W.config["poll-time"])||5),We="BILI_MIRROR_REPORT_POOL";(null==W?void 0:W.config["poll-time"])||setTimeout((function(){Je=6e4*((null==W?void 0:W.config["poll-time"])||5)}),1e3);var qe=function(){try{var e=JSON.parse(localStorage.getItem(We)||"{}");if(!Object.keys(e).length)return;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];Fe.tech(t,n)})),localStorage.setItem(We,"{}")}catch(e){}},Ge=function(){Ve||((Ve=new Be).repeat(qe,Je),l(c,"beforeunload",(function(){qe(),$e()})))},$e=function(){Fe&&Fe.flush&&Fe.flush(),Ve&&Ve.clear()},Ye="_BiliGreyResult",Xe=function(){var e=Qe("offline-version"),t=Qe("offline-name"),n=Qe("offline-plat");return e?{offlineVersion:e,offlineName:t,offlinePlat:n}:{}},Qe=function(e){var t;return(null===(t=document.getElementsByTagName("meta")[e])||void 0===t?void 0:t.content)||void 0},ze="//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js",Ze=function(){if(!a())return{};if(!c[Ye])return{};var e=c[Ye],n={};Object.entries(e).forEach((function(e){var t=e[0],r=e[1];n["".concat(Ye,"_").concat(t)]=r}));var r=Xe();return t(t({},n),r)}(),et=[],tt=!1,nt="",rt=null;function ot(){if(et.length&&!tt){tt=!0;var e=et.shift(),t=e[0],n=e[1],r=e[2],o=e[3];if("middleWare"===n){if(rt)return tt=!1,ut(r,o),void ot();t(!0).then((function(e){var t;tt=!1,Fe!==(t=rt=e)&&(Fe=t),lt(r,o),ot()}))}else t().then((function(){tt=!1,n&&r&&n(r,o||void 0),ot()}))}}var it=function(e){(nt?window[nt]:window.__biliMirrorPbInstance__)[(e=dt(e)).type](e.otherSpmId?"".concat(e.otherSpmId,".").concat(e.eventId):(null==W?void 0:W.spmId)?"".concat(null==W?void 0:W.spmId,".").concat(e.eventId):"".concat(u,".").concat(e.eventId),e.msg)},at=function(e,n){n&&Object.keys(n).length>0&&ft(n);var r="";r=(e=dt(e)).diyevent?e.eventId||e.event:"".concat(e.otherSpmId?e.otherSpmId:(null==W?void 0:W.spmId)?null==W?void 0:W.spmId:u,".").concat(e.eventId);var o=nt?window[nt]:window.__biliMirrorPbInstance__,i=t(t(t({},e.msg),Ze),{mirrorVersion:S,type:e.type||"custom"});o.tech(r,i)},ct=function(e){et.push([pt,it,e]),ot()},st=function(e,t){et.push([pt,at,e,t]),ot()},ut=function(e,t){!e.msg.message&&e.msg.msg&&(e.msg.message=e.msg.msg),rt?lt(e,t):(et.push([pt,"middleWare",e,t]),ot())},lt=function(e,n){n&&void 0!==(null==n?void 0:n.isBatch)||(n=Object.assign(n||{},{isBatch:!1}));var r=((null==n?void 0:n.spmId)||u)+"."+((null==n?void 0:n.origin)||(null==W?void 0:W.origin))+"."+((null==n?void 0:n.module)||(null==W?void 0:W.module));(null==n?void 0:n.isBatch)?function(e,n,r){var o,i=(null===(o=null==n?void 0:n.api)||void 0===o?void 0:o.split("?")[0])||"";try{var a=JSON.parse(localStorage.getItem(We)||"{}");a[e]||(a[e]=t(t({},r),Ke)),a[e][i]?a[e][i]++:a[e][i]=1,localStorage.setItem(We,JSON.stringify(a))}catch(e){}Ge()}(r+(n.eventId||".DATA.successReport"),e.msg,t({type:"custom",mirrorVersion:S},Ze)):rt.tech(r+(n.eventId||".ERROR.errorReport"),t(t({type:e.type||"custom",mirrorVersion:S},e.msg),Ze))},ft=function(e){void 0===e&&(e={feature:{tech:!0}});window.__biliMirrorPbInstance__.options=Object.assign({feature:{tech:!0}},e)},pt=function(e){void 0===e&&(e=!1);try{return new Promise((function(n,r){if(a()||r("not support in server"),e){var o={feature:{tech:!0},autoPv:!1,batch:!1};if(window.ReporterPb){var i=new window.ReporterPb(t({},o));n(i)}else{(s=document.createElement("script")).src=ze,document.getElementsByTagName("body")[0].appendChild(s),s.onload=function(){var e=new window.ReporterPb(t({},o));n(e)}}}else{var c=(null==W?void 0:W.pbOtherNameIns)?null==W?void 0:W.pbOtherNameIns:"";if(h.isObject(window[c])&&Object.keys(window[c]).length)nt=c,console.warn("Is using ".concat(c," to report,Please confirm open [tech] config")),n();else if(window.__biliMirrorPbInstance__)n();else{var s,u=O({feature:{tech:!0}},(null==W?void 0:W.pbOptions)||{});if(window.ReporterPb)window.__biliMirrorPbInstance__=new window.ReporterPb(u),n();else(s=document.createElement("script")).src=ze,document.getElementsByTagName("body")[0].appendChild(s),s.onload=function(){window.__biliMirrorPbInstance__=new window.ReporterPb(u),n()}}}}))}catch(e){console.error("bili-mirror:load pb-report-Error load failed:",e)}};function dt(e){return e.event&&!e.eventId&&(e.eventId=e.event),e.eventId.split(".").length<=1&&(e.eventId="".concat(null==W?void 0:W.origin,".").concat(null==W?void 0:W.module,".").concat(e.eventId)),"appear"===e.type&&(e.type="exposure"),e}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function ht(e,t){return e(t={exports:{}},t.exports),t.exports}var mt=ht((function(e,t){e.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function n(e){return function(){return this[e]}}var r=["isConstructor","isEval","isNative","isToplevel"],o=["columnNumber","lineNumber"],i=["fileName","functionName","source"],a=["args"],c=["evalOrigin"],s=r.concat(o,i,a,c);function u(e){if(e)for(var n=0;n<s.length;n++)void 0!==e[s[n]]&&this["set"+t(s[n])](e[s[n]])}u.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof u)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new u(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",n=this.getColumnNumber()||"",r=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+n+")":"[eval]:"+t+":"+n:r?r+" ("+e+":"+t+":"+n+")":e+":"+t+":"+n}},u.fromString=function(e){var t=e.indexOf("("),n=e.lastIndexOf(")"),r=e.substring(0,t),o=e.substring(t+1,n).split(","),i=e.substring(n+1);if(0===i.indexOf("@"))var a=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(i,""),c=a[1],s=a[2],l=a[3];return new u({functionName:r,args:o||void 0,fileName:c,lineNumber:s||void 0,columnNumber:l||void 0})};for(var l=0;l<r.length;l++)u.prototype["get"+t(r[l])]=n(r[l]),u.prototype["set"+t(r[l])]=function(e){return function(t){this[e]=Boolean(t)}}(r[l]);for(var f=0;f<o.length;f++)u.prototype["get"+t(o[f])]=n(o[f]),u.prototype["set"+t(o[f])]=function(t){return function(n){if(!e(n))throw new TypeError(t+" must be a Number");this[t]=Number(n)}}(o[f]);for(var p=0;p<i.length;p++)u.prototype["get"+t(i[p])]=n(i[p]),u.prototype["set"+t(i[p])]=function(e){return function(t){this[e]=String(t)}}(i[p]);return u}()})),vt=ht((function(e,t){var n,r,o,i;e.exports=(n=mt,r=/(^|@)\S+:\d+/,o=/^\s*at .*(\S+:\d+|\(native\))/m,i=/^(eval@)?(\[native code])?$/,{parse:function(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(o))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(o)}),this).map((function(e){e.indexOf("(eval ")>-1&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),r=t.match(/ (\(.+\)$)/);t=r?t.replace(r[0],""):t;var o=this.extractLocation(r?r[1]:t),i=r&&t||void 0,a=["eval","<anonymous>"].indexOf(o[0])>-1?void 0:o[0];return new n({functionName:i,fileName:a,lineNumber:o[1],columnNumber:o[2],source:e})}),this)},parseFFOrSafari:function(e){return e.stack.split("\n").filter((function(e){return!e.match(i)}),this).map((function(e){if(e.indexOf(" > eval")>-1&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===e.indexOf("@")&&-1===e.indexOf(":"))return new n({functionName:e});var t=/((.*".+"[^@]*)?[^@]*)(?:@)/,r=e.match(t),o=r&&r[1]?r[1]:void 0,i=this.extractLocation(e.replace(t,""));return new n({functionName:o,fileName:i[0],lineNumber:i[1],columnNumber:i[2],source:e})}),this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,r=e.message.split("\n"),o=[],i=2,a=r.length;i<a;i+=2){var c=t.exec(r[i]);c&&o.push(new n({fileName:c[2],lineNumber:c[1],source:r[i]}))}return o},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,r=e.stacktrace.split("\n"),o=[],i=0,a=r.length;i<a;i+=2){var c=t.exec(r[i]);c&&o.push(new n({functionName:c[3]||void 0,fileName:c[2],lineNumber:c[1],source:r[i]}))}return o},parseOpera11:function(e){return e.stack.split("\n").filter((function(e){return!!e.match(r)&&!e.match(/^Error created at/)}),this).map((function(e){var t,r=e.split("@"),o=this.extractLocation(r.pop()),i=r.shift()||"",a=i.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;i.match(/\(([^)]*)\)/)&&(t=i.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var c=void 0===t||"[arguments not available]"===t?void 0:t.split(",");return new n({functionName:a,args:c,fileName:o[0],lineNumber:o[1],columnNumber:o[2],source:e})}),this)}})})),gt=function(e){var n=e.target;if(null==n?void 0:n.localName){var r=function(e){return{time:f(),message:e.src||e.href||"",name:e.localName}}(n);return t(t({},r),{type:"resourceError"})}return null},yt=function(e,t){void 0===t&&(t=!0);var n=e.method.toLocaleUpperCase(),r="POST"===n?JSON.stringify(e.data):"",o="GET"===n?function(e){if(!Object.keys(e).length)return"";var t="";for(var n in e)t+="".concat(n,"=").concat(e[n],"&");return t.substring(0,t.length-1)}(e.data):"",i=o?-1!==e.url.indexOf("?")?"".concat(e.url,"&").concat(o):"".concat(e.url,"?").concat(o):e.url;return new Promise((function(o,a){var c=new XMLHttpRequest;if(c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE)if(200===c.status){var e=null;try{e=JSON.parse(c.responseText)}catch(t){e=c.responseText}o(e)}else{var t=c.getAllResponseHeaders().trim().split(/[\r\n]+/),n={};t.forEach((function(e){var t=e.split(": "),r=t.shift(),o=t.join(": ");n[r]=o})),a({responseText:c.responseText,headers:n,status:c.status})}},c.withCredentials=t,c.open(n,i,!0),"POST"===n&&e.headers&&"object"==typeof e.headers)for(var s in e.headers)c.setRequestHeader(s,e.headers[s]);c.send(r)}))},bt=null,Rt=function(){function e(){}return e.prototype.before=function(e,t){var o=this;return new Promise((function(i){return n(o,void 0,void 0,(function(){var n,o,a;return r(this,(function(r){switch(r.label){case 0:if(!W.plugins||!h.isArray(W.plugins))return[3,5];r.label=1;case 1:return r.trys.push([1,3,,4]),n=W.plugins,[4,Ue(n,"before",{type:e,data:t}).start()];case 2:return o=r.sent(),a=o.slice(-1)[0],i(a),[3,4];case 3:return r.sent(),console.warn("bili-mirror:plugin function before hook error,please check"),i(!0),[3,4];case 4:return[3,6];case 5:if(W.plugins&&W.plugins.mirrorHandleBefore)try{W.plugins.mirrorHandleBefore(e,t).then((function(e){i(e)}))}catch(e){console.warn("bili-mirror:plugin function before hook error,please check"),i(!0)}else i(!0);r.label=6;case 6:return[2]}}))}))}))},e.prototype.after=function(e,t){var o=this;return new Promise((function(i){return n(o,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:if(!W.plugins||!h.isArray(W.plugins))return[3,5];r.label=1;case 1:return r.trys.push([1,3,,4]),n=W.plugins,[4,Ue(n,"after",{type:e,data:t}).start()];case 2:return r.sent(),i(),[3,4];case 3:return r.sent(),console.warn("bili-mirror:plugin function after hook error,please check"),i(),[3,4];case 4:return[3,6];case 5:if(W.plugins&&W.plugins.mirrorHandleAfter)try{W.plugins.mirrorHandleAfter(e,t).then((function(){i()}))}catch(e){console.warn("bili-mirror:plugin function after hook error,please check"),i()}else i();r.label=6;case 6:return[2]}}))}))}))},e}();bt||(bt=new Rt);var Et=bt,wt=s(),Ot=function(){function e(){this.maxBreadcrumbs=10,this.stack=[]}return e.prototype.push=function(e){return n(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){switch(n.label){case 0:return[4,Et.before(Q.BREABCRUMB,e)];case 1:return n.sent()?(this.immediatePush(e),l(c,"beforeunload",(function(){t.stack.filter((function(e){return"error"===e.status})).length&&(t.goToReport(t.stack),window.__biliMirrorPbInstance__&&window.__biliMirrorPbInstance__.flush&&window.__biliMirrorPbInstance__.flush())})),[2]):[2]}}))}))},e.prototype.immediatePush=function(e){(e.time||(e.time=f()),this.stack.length>=this.maxBreadcrumbs)&&(this.stack.filter((function(e){return"error"===e.status})).length?(this.goToReport(this.stack),this.clear()):this.clear());this.stack.push(e),this.stack.sort((function(e,t){return e.time-t.time}))},e.prototype.shift=function(){return void 0!==this.stack.shift()},e.prototype.clear=function(){this.stack=[]},e.prototype.getStack=function(){return this.stack},e.prototype.goToReport=function(e){var n={};e.forEach((function(e,t){n["logStep-".concat(t)]=e})),st({type:"custom",event:"".concat(W.origin,".").concat(W.module,".USERLOG"),msg:t({userLogInfo:t({},n)},He)}),Et.after(Q.BREABCRUMB,this.stack),this.clear()},e}(),St=a()?wt.breadcrumb||(wt.breadcrumb=new Ot):null,Tt=null,It=function(){function e(){}return e.prototype.handleHistory=function(e){var t=e.from,n=e.to,r=R(t).relative,o=R(n).relative;St.push({category:z.HISTORY,status:ee.OK,time:f(),msg:{from:r||"/",to:o||"/"}})},e.prototype.handleHashChange=function(e){var t=e.oldURL,n=e.newURL,r=R(t).relative,o=R(n).relative;St.push({category:z.HASHCHANGE,status:ee.OK,time:f(),msg:{from:r,to:o}})},e.prototype.handleDomClick=function(e){var t=function(e){var t=e.tagName.toLowerCase();if("body"===t)return"";var n=e.classList.value;n=""!==n?" class='".concat(n,"'"):"";var r=e.id?' id="'.concat(e.id,'"'):"",o=e.innerText;return"<".concat(t).concat(r).concat(""!==n?n:"",">").concat(o,"</").concat(t,">")}(e.activeElement);t&&St.push({category:z.CLICK,status:ee.OK,time:f(),msg:{clickDom:t}})},e.prototype.handleJsError=function(e){St.push({category:z.ERROR,status:ee.ERROR,time:e.time||f(),msg:{message:e.message}})},e.prototype.handlePromiseError=function(e){St.push({category:z.UNHANDLEDREJECTION,status:ee.ERROR,time:e.time||f(),msg:{message:e.message}})},e.prototype.handleResourceError=function(e){St.push({category:z.RESOURCE,status:ee.ERROR,time:e.time||f(),msg:{message:e.message,name:null==e?void 0:e.name}})},e.prototype.handleWhiteScreen=function(){St.push({category:z.WHITE,status:ee.ERROR,time:f(),msg:{url:location.href}})},e}();Tt||(Tt=new It);var Pt=Tt,Nt=b();function _t(e){var t=(null==W?void 0:W.config["user-log"])||null;return!!t&&t.find((function(t){return t===e}))}var kt,Ct={historyReplace:function(){if(_t(ne.HISTORY)&&(e=c.chrome,t=e&&e.app&&e.app.runtime,n="history"in c&&!!c.history.pushState&&!!c.history.replaceState,!t&&n)){var e,t,n,r=c.onpopstate;c.onpopstate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=b(),o=Nt;Nt=n,Pt.handleHistory({from:o,to:n}),r&&r.apply(this,e)},E(c.history,"pushState",o),E(c.history,"replaceState",o)}function o(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=t.length>2?t[2]:void 0;if(r){var o=Nt,i=String(r);Nt=i,Pt.handleHistory({from:o,to:i})}return e.apply(this,t)}}},hashChangeeReplace:function(){var e,t;_t(ne.HASH)&&(e=c,t="onhashchange",Object.prototype.hasOwnProperty.call(e,t)&&l(c,"hashchange",(function(e){Pt.handleHashChange(e)})))},domClickReplace:function(){if(_t(ne.DOM)&&"document"in c){var e,t,n,r=(e=Pt.handleDomClick,t=300,n=!0,function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n&&(e.apply(this,r),n=!1,setTimeout((function(){n=!0}),t))});l(c.document,"click",(function(){r(this)}),!0)}},jsErrorReplace:function(e){_t(ne.JS)&&(null==Pt||Pt.handleJsError(e))},promiseErrorReplace:function(e){_t(ne.PROMISE)&&(null==Pt||Pt.handlePromiseError(e))},resourceErrorReplace:function(e){_t(ne.RESOURCE)&&(null==Pt||Pt.handleResourceError(e))},whiteErrorReplace:function(){_t(ne.WHITE)&&(null==Pt||Pt.handleWhiteScreen())}},Lt=[],At=function(e){var t,n=(t=(null==e?void 0:e.message)||(null==e?void 0:e.fileName),window.btoa(decodeURIComponent(encodeURIComponent(t))));return Lt.some((function(e){return e===n}))?(console.warn("Duplicate error, not reported,".concat(null==e?void 0:e.message)),!1):(Lt.push(n),!0)},jt={},xt={handleError:function(e){var o,i,a,s,u;return n(this,void 0,void 0,(function(){var l,p,d,h,m,g,y;return r(this,(function(b){switch(b.label){case 0:if((null==c?void 0:c.screen.width)<=100||c.screen.height<=100)return[2];if((null==c?void 0:c.innerWidth)<=100||c.innerHeight<=100)return[2];l=e.target,b.label=1;case 1:return b.trys.push([1,7,,8]),!l||e.target&&!e.target.localName?(p=function(e){var t,n=e.target;if(!n||e.target&&!(null===(t=e.target)||void 0===t?void 0:t.localName)){var r=vt.parse(n?e.error:e).slice(0,5),o=[];r.forEach((function(e){var t=e.source,n=t?t.split(" ").join("").split("./"):"";o.push(n)}));var i=vt.parse(n?e.error:e)[0],a=i.fileName,c=i.columnNumber,s=i.lineNumber;return{type:"error",time:f(),message:e.message,fileName:a,line:s,column:c,stack:JSON.stringify(o)}}return null}(e),d=null===(i=null===(o=null==W?void 0:W.config)||void 0===o?void 0:o.white)||void 0===i?void 0:i.error,v(p,d)?[3,3]:At(p)?[4,Et.before(Q.ERROR,p)]:[2]):[3,3];case 2:if(!b.sent())return[2];st({type:"error",eventId:"".concat(W.origin,".").concat(W.module,".ERROR.jsError"),msg:p},W.pbOptions||{}),Ct.jsErrorReplace(p),Et.after(Q.ERROR,p),b.label=3;case 3:return(null==l?void 0:l.localName)?(h=gt(e),m=null===(s=null===(a=null==W?void 0:W.config)||void 0===a?void 0:a.white)||void 0===s?void 0:s.resource,v(h,m)?[3,6]:[4,(R=h,E=null===(u=null==W?void 0:W.config)||void 0===u?void 0:u["white-retry"],void 0===E&&(E=[]),n(void 0,void 0,void 0,(function(){return r(this,(function(e){return R.message?(void 0===jt[R.name]&&(jt[R.name]=2),jt[R.name]>0?(jt[R.name]--,v(R,E)?[2,Promise.resolve({retryResult:"whitelist"})]:[2,new Promise((function(e){yt({url:R.message,method:"GET",data:{},headers:{}},!1).then((function(){e({retryResult:"success"})})).catch((function(n){e(t({retryResult:"failed"},n))}))}))]):[2,Promise.resolve({retryResult:"skip"})]):[2,Promise.resolve({retryResult:"skip"})]}))})))]):[3,6];case 4:return g=b.sent(),h=t(t({},h),g),At(h)?[4,Et.before(Q.RESOURCE,h)]:[2];case 5:if(!b.sent())return[2];st({type:"error",eventId:"".concat(W.origin,".").concat(W.module,".ERROR.resourceError"),msg:t(t({},h),{error_type:"AssetsError",headless:""==navigator.language?"headless":"normal",webdriver:null===navigator||void 0===navigator?void 0:navigator.webdriver})},W.pbOptions||{}),Ct.resourceErrorReplace(h),Et.after(Q.RESOURCE,h),b.label=6;case 6:return[3,8];case 7:return y=b.sent(),console.warn("bili-mirror: handleError-Error parsing failed:",y),[3,8];case 8:return[2]}var R,E}))}))},handleUnhandleRejection:function(e){var t,o;return n(this,void 0,void 0,(function(){var n,i,a;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),(null==c?void 0:c.screen.width)<=100||c.screen.height<=100?[2]:(null==c?void 0:c.innerWidth)<=100||c.innerHeight<=100?[2]:(n=function(e){var t=vt.parse(e.reason).slice(0,5),n=[];t.forEach((function(e){var t=e.source,r=t?t.split(" ").join("").split("./"):"";n.push(r)}));var r,o=vt.parse(e.reason)[0],i=o.fileName,a=o.columnNumber,c=o.lineNumber;return{type:"rejectionError",time:f(),message:(r=e.reason.message||e.reason.stack,h.isString(r)?r:h.isUndefined(r)?"undefined":JSON.stringify(r)),fileName:i,line:c,column:a,stack:JSON.stringify(n)}}(e),i=null===(o=null===(t=null==W?void 0:W.config)||void 0===t?void 0:t.white)||void 0===o?void 0:o.rejection,v(n,i)?[3,2]:At(n)?[4,Et.before(Q.UNHANDLEDREJECTION,n)]:[2]);case 1:if(!r.sent())return[2];st({type:"error",eventId:"".concat(W.origin,".").concat(W.module,".ERROR.rejectionError"),msg:n},W.pbOptions||{}),Ct.promiseErrorReplace(n),Et.after(Q.UNHANDLEDREJECTION,n),r.label=2;case 2:return[3,4];case 3:return a=r.sent(),console.warn("bili-mirror: handleUnhandleRejection-Error parsing failed:",a),[3,4];case 4:return[2]}}))}))},handlePerformance:function(){return n(this,void 0,void 0,(function(){var e=this;return r(this,(function(o){try{if(!PerformanceObserver||!(null===PerformanceObserver||void 0===PerformanceObserver?void 0:PerformanceObserver.supportedEntryTypes))return[2];if(y(W.config["white-preformance-rate"]))return[2];De((function(o){return n(e,void 0,void 0,(function(){var e,n;return r(this,(function(r){switch(r.label){case 0:return e=o.name,!(n=o.value)||n<0?[2]:[4,Et.before(Q.PERFORMANCE,o)];case 1:return r.sent()?(st({type:"performance",eventId:"".concat(W.origin,".").concat(W.module,".PERFORMANCE.").concat(o.name),msg:t({},"PAGETIME"===e?null==o?void 0:o.data:o)},W.pbOptions||{}),Et.after(Q.PERFORMANCE,o),[2]):[2]}}))}))}))}catch(e){console.warn("bili-mirror: performance-Error parsing failed:",e)}return[2]}))}))}};!function(e){e.ERROR="error",e.OK="ok"}(kt||(kt={}));var Mt=null,Dt=null,Ht="BILI_MIRROR_RESOURCE_TIME",Kt=["xmlhttprequest","fetch","img","image","link","css","video","iframe","script"],Ut={API:"xmlhttprequest,fetch",IMG:"img,image",CSS:"link,css",JS:"script",VIDEO:"video",IFRAME:"iframe"},Bt=function(){function e(){this._cleanUpReportPool=function(){Mt&&Mt.clear(),window.__biliMirrorPbInstance__&&window.__biliMirrorPbInstance__.flush&&window.__biliMirrorPbInstance__.flush()},this.config=W.config["resource-time"]||{},this.resourceWaitList=[],this.disablePush=!1}return e.prototype.on=function(){PerformanceObserver&&(null===PerformanceObserver||void 0===PerformanceObserver?void 0:PerformanceObserver.supportedEntryTypes)&&(this._getAllData(),this._createObserver())},e.prototype.destroy=function(){Dt&&Dt.disconnect(),Mt&&Mt.clear()},e.prototype._getAllData=function(){var e=this,t=performance.getEntriesByType("resource");(t||t.length)&&t.forEach((function(t){e.resourceWaitList.push(t)}))},e.prototype._handlerResourceInit=function(){for(this.disablePush=!0;this.resourceWaitList.length;){var e=this.resourceWaitList.shift();if(this._isCheckResource(e)){var t=this._computeResourceData_(e);this._addResourceReportPool(t)}}this.disablePush=!1,this._startReportInterval()},e.prototype._isCheckResource=function(e){if(!Kt.includes(e.initiatorType))return!1;if(!Object.keys(this.config).length)return!1;var t=!1;for(var n in this.config){if(Ut[n].split(",").includes(e.initiatorType)){if("*"===this.config[n]){t=!0;break}if(!this.config[n])continue;if(Array.isArray(this.config[n])&&this.config[n].length)for(var r=0;r<this.config[n].length;r++){if(e.name.split("?")[0].match(this.config[n][r])){t=!0;break}}}}return t},e.prototype._computeResourceData_=function(e){var t=e.name.split("?"),n=e.transferSize,r=e.initiatorType,o=e.duration,i=e.nextHopProtocol,a=e.redirectStart,c=e.redirectEnd,s=e.domainLookupEnd,u=e.domainLookupStart,l=e.connectEnd,f=e.connectStart,p=e.secureConnectionStart,d=e.responseStart,h=e.requestStart,m=e.responseEnd;return{url:t[0],query:t[1],duration:o.toFixed(2),size:n,type:r,protocol:i,redirectTime:c-a,dnsTime:s-u,sslTime:l-p,tcpTime:l-f,requestTime:d-h,responseTime:m-d}},e.prototype._addResourceReportPool=function(e){var n=JSON.parse(localStorage.getItem(Ht)||"{}"),r=e.url;n[r]||(n[r]=t({},e)),localStorage.setItem(Ht,JSON.stringify(n))},e.prototype._startReportInterval=function(){var e=this;Mt||((Mt=new Be).repeat(this._clearResourceReport,18e4),l(c,"beforeunload",(function(){e._clearResourceReport(),e._cleanUpReportPool()})))},e.prototype._clearResourceReport=function(){try{var e=JSON.parse(localStorage.getItem(Ht)||"{}");Object.keys(e).length&&st({type:"performance",eventId:"".concat(W.origin,".").concat(W.module,".PERFORMANCE.RESOURCETIME"),msg:{resourceListInfo:t({},e)}}),localStorage.setItem(Ht,"")}catch(e){}},e.prototype._createObserver=function(){var e=this;(Dt=new PerformanceObserver((function(t){t.getEntries().forEach((function(t){e.resourceWaitList.push(t.toJSON())})),e.disablePush||e._handlerResourceInit()}))).observe({entryTypes:["resource"]})},e}();function Ft(e){var o;if(a()){if(l(c,"error",(function(e){xt.handleError(e)}),!0),l(c,"unhandledrejection",(function(e){xt.handleUnhandleRejection(e)})),xt.handlePerformance(),null==e?void 0:e.whiteScreen)try{!function(e){if(!((null==c?void 0:c.screen.width)<=0||c.screen.height<=0||(null==c?void 0:c.innerWidth)<=0||c.innerHeight<=0)){var o=e.checkNum||3,i=e.maxLoop||9,a=e.elemArry||e.checkDom||["html","body","#app"],u=e.callback||function(){},l=s(),f=0,p=[],d=[],h={};e.isSkeleton?"complete"!=document.readyState&&g():"complete"===document.readyState?g():c.addEventListener("load",g)}function m(e){return e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").filter((function(e){return!!e})).join("."):e.nodeName.toLowerCase()}function v(t){var n=m(t);e.isSkeleton&&(f?d.push(n):p.push(n));var r=!1;if(!n||!a)return r;for(var o=0;o<=a.length;o++)if(a[o]&&n.match(a[o])){r=!0;break}return r}function g(){return n(this,void 0,void 0,(function(){var n,s,g,b,R,E,w,O,S,T,I,P;return r(this,(function(r){switch(r.label){case 0:return document&&document.elementsFromPoint?[4,Et.before(Q.WHITESCREEN)]:(console.warn("当前浏览器不支持elementsFromPoint方法,白屏检测跳过"),[2]);case 1:if(!r.sent())return[2];for(h.check_list=a,n=!0,s=1;s<=7;s+=3){if(g=c.innerWidth*s/10,b=c.innerHeight/2,R=c.innerWidth/2,E=c.innerHeight*s/10,w=document.elementsFromPoint(g,b),O=document.elementsFromPoint(R,E),w.length>o){for(S=[],h["pointX-".concat(g,"-").concat(b)]||(h["pointX-".concat(g,"-").concat(b)]=[]),T=0;T<w.length;T++)if(S.push(m(w[T])),v(w[T])){n=!1;break}h["pointX-".concat(g,"-").concat(b)].length||(h["pointX-".concat(g,"-").concat(b)]=S)}if(!n)break;if(n&&O.length>o&&5!=s){for(I=[],h["pointY-".concat(R,"-").concat(E)]||(h["pointY-".concat(R,"-").concat(E)]=[]),P=0;P<O.length;P++)if(I.push(m(O[P])),v(O[P])){n=!1;break}h["pointY-".concat(R,"-").concat(E)].length||(h["pointY-".concat(R,"-").concat(E)]=I)}if(!n)break}if(n)y();else{if(e.isSkeleton){if(!f)return[2,y()];if(d.join()==p.join())return[2,u({status:kt.ERROR})]}l._loopTimer&&clearTimeout(l._loopTimer),l._loopTimer=null}return u({status:n?kt.ERROR:kt.OK,loop:f,data:t({},h)}),f>=i&&(st({type:"error",eventId:"".concat(W.origin,".").concat(W.module,".ERROR.whiteScreen"),msg:{_BiliCheckDom_Point:t({},h)}}),Ct.whiteErrorReplace()),Et.after(Q.WHITESCREEN,t({},h)),[2]}}))}))}function y(){f>=i&&l._loopTimer?(clearTimeout(l._loopTimer),l._loopTimer=null):l._loopTimer=setTimeout((function(){f++,e.isSkeleton&&(d=[]),g()}),1e3)}}(e.whiteScreen)}catch(e){console.error("bili-mirror: whiteScreen错误解析异常:",e)}if(null===(o=null==W?void 0:W.config["user-log"])||void 0===o?void 0:o.length)try{Ct.historyReplace(),Ct.hashChangeeReplace(),Ct.domClickReplace()}catch(e){console.error("bili-mirror:user-log记录解析异常",e)}W.config["resource-time"]&&Object.keys(W.config["resource-time"]).length&&l(c,"load",(function(){var e=new Bt;try{e.on()}catch(t){e.destroy(),console.warn("bili-mirror:resource-watch error",t)}}))}}var Vt,Jt=function(e){void 0===e&&(e={});var n=null==W?void 0:W.config["tech-pv"];if(n&&!y(n)){var r="".concat(W.origin,".").concat(W.module,".TECHPV.0.0");st({eventId:r,type:"custom",msg:t(t({},e),He)})}},Wt=s(),qt=function(e){a()&&ct(e)};function Gt(e){var t=this;a()&&(Wt.isInited||(Wt.isInited=!0,Wt.mirrorInitMode||(Wt.mirrorInitMode=te.DEFAULT),q(e).then((function(){return n(t,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Et.before(Q.INIT,e)];case 1:return t.sent()?(Ft(null==e?void 0:e.config),Jt(),Et.after(Q.INIT,e),console.info("%c%s","line-height: 30px; color: #FF6699","bili-fe-mirror:".concat(I)),[2]):[2]}}))}))}))))}if(a()){window.__INITIAL_MIRROR__=Gt;var $t=window.__MIRROR_CONFIG__,Yt=null===(Vt=null==$t?void 0:$t.config)||void 0===Vt?void 0:Vt.isAutoInit;$t&&h.isObject($t)&&Yt&&(!Wt.mirrorInitMode&&(Wt.mirrorInitMode=te.AUTO),Gt($t))}var Xt={SDK_NAME:T,SDK_VERSION:I,init:Gt,install:function(e,t){void 0===t&&(t={});var n=e.config.errorHandler;e.config.errorHandler=function(e,t,r){xt.handleError(e),n&&n.apply(null,[e,t,r]),console.error(e)},Gt(t)},errorBoundary:function(e){xt.handleError(e)}};e.canBatchTechReport=function(e,t){a()&&ut(e,t)},e.changeMirrorModule=function(e){var t,n;t=e,null==(n=J())||n.updateModule(t)},e.changePbOptions=function(e){a()&&ft(e)},e.customPerformanceQuota=function(e){if(a()&&m(e.name)){var t="".concat(W.origin,".").concat(W.module,".PERFORMANCE.").concat(e.name);st({type:"performance",eventId:t,msg:{name:e.name,value:e.value}})}},e.customReport=qt,e.customReportPb=qt,e.default=Xt,e.exclusiveBisReport=function(e){a()&&m(e.key)&&st({type:"custom",eventId:e.eventId,diyevent:!0,msg:t(t({exclusiveFrom:(null==e?void 0:e.key)||""},e.msg),He)})},e.mirrorTechPvReport=function(e){void 0===e&&(e={}),Jt(e)},e.pbReportPv=function(e,t){a()&&ct({type:"pv",eventId:"0.0",msg:e,otherSpmId:t||null})},e.techReportPb=function(e){a()&&st(e)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=biliMirror.umd.mini.js.map
